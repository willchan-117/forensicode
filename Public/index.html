<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ForensiCode, The Human Verification Checker</title>
 <style>
:root{
  --bg:#f4f6f8;
  --card:#fff;
  --muted:#6b7280;
  --brand:#1b84ff;
  --ok:#1e8e3e;
  --bad:#d93025;
  --mono:"Roboto Mono", monospace;
  --radius:12px;
}

html,body{
  height:100%;
  margin:0;
  font-family:"Satoshi", Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  background:var(--bg);
  color:#111;
}

.wrap{max-width:1060px;margin:32px auto;padding:22px;}

header{
  display:flex;
  gap:18px;
  align-items:center;
  margin-bottom:18px;
}

header img{width:64px;height:64px;}

h1{font-size:22px;margin:0}
p.lead{margin:4px 0 0;color:var(--muted);font-size:13px}

.grid{display:flex;gap:18px;flex-wrap:wrap}
.col{flex:1 1 360px;min-width:320px}

.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:18px;
  box-shadow:0 8px 26px rgba(12,20,30,.06);
  border:1px solid #e6ecf5;
}

label{display:block;font-weight:700;margin-bottom:8px}
.muted{color:var(--muted);font-size:13px;margin-bottom:8px}

#drop-area{
  border:2px dashed #d8dde6;
  border-radius:10px;
  padding:26px;
  text-align:center;
  cursor:pointer;
  color:var(--muted);
  transition:all .14s ease;
}

#drop-area:hover{transform:translateY(-2px)}
#drop-area.highlight{
  background:linear-gradient(90deg,rgba(27,132,255,.06),rgba(27,132,255,.02));
  border-color:var(--brand);
  color:var(--brand);
}

input[type=file]{display:none}

#status-box{
  margin-top:12px;
  padding:12px;
  border-radius:8px;
  background:#fbfcfe;
  border:1px solid #edf2f9;
  min-height:96px;
}

.file-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}

.file-name{font-size:13px;color:#1f2937}

.file-badge{
  font-size:13px;
  padding:6px 10px;
  border-radius:8px;
  font-weight:700;
}

.badge-miss{
  background:#fff3f3;
  color:var(--bad);
  border:1px solid rgba(217,48,37,.12);
}

.badge-ok{
  background:#f3fff6;
  color:var(--ok);
  border:1px solid rgba(30,142,62,.12);
}

.small{font-size:12px;color:var(--muted)}

.btn{
  display:inline-block;
  background:var(--brand);
  color:#fff;
  padding:10px 14px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  font-weight:800;
  margin-top:10px;
}

.btn:disabled{
  opacity:.45;
  cursor:not-allowed;
  transform:none;
}

#result{
  margin-top:16px;
  padding:14px;
  border-radius:10px;
  white-space:pre-wrap;
  font-size:14px;
}

.result-pass{
  background:#f3fff6;
  border:1px solid rgba(30,142,62,.12);
  color:var(--ok);
}

.result-fail{
  background:#fff4f4;
  border:1px solid rgba(217,48,37,.12);
  color:var(--bad);
}

details{margin-top:12px}

.meta{
  font-family:var(--mono);
  font-size:13px;
  color:#263238;
  background:#f8fafc;
  padding:10px;
  border-radius:8px;
  border:1px solid #eef3fb;
  max-height:420px;
  overflow:auto;
}

.truncate{max-height:220px;overflow:hidden}

.show-more{
  margin-top:8px;
  display:inline-block;
  color:var(--brand);
  cursor:pointer;
  font-weight:700;
  background:transparent;
  border:none;
  padding:6px 8px;
  border-radius:8px;
}

.copy-btn{
  margin-left:8px;
  padding:6px 10px;
  border-radius:8px;
  border:1px solid #e6eefc;
  background:white;
  cursor:pointer;
  font-weight:700;
}

footer{
  margin-top:22px;
  color:var(--muted);
  font-size:13px;
}

.hint{
  font-size:12px;
  color:var(--muted);
  margin-top:8px;
}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="ForensiCode_logo.svg" alt="ForensiCode" onerror="this.style.display='none'">
      <div>
        <h1>ForensiCode, The Human Verification Checker</h1>
        <p class="lead">
          Verify a student's exported report (.json) and the original .docx file locally ‚Äî
          no uploading, no servers.
        </p>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <div class="col">
        <div class="card">
          <label>1) Upload files</label>

          <div id="drop-area" tabindex="0" role="button">
            <div style="font-weight:800;margin-bottom:8px">
              Drop .docx + .json here
            </div>
            <div class="small">
              Or click to select. Include both the exported telemetry JSON and the DOCX.
            </div>
            <input id="file-input" type="file" multiple accept=".docx,.json">
          </div>

          <div id="status-box">
            <div class="file-row">
              <div>
                <div class="small">Document (.docx)</div>
                <div id="docx-name" class="file-name">‚Äî no file selected ‚Äî</div>
              </div>
              <div id="docx-badge" class="file-badge badge-miss">Missing</div>
            </div>

            <div class="file-row">
              <div>
                <div class="small">Report (.json)</div>
                <div id="json-name" class="file-name">‚Äî no file selected ‚Äî</div>
              </div>
              <div id="json-badge" class="file-badge badge-miss">Missing</div>
            </div>

            <div class="hint">
              Tip: The JSON must include <code>reportIntegrityHash</code> and telemetry sessions.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="col">
        <div class="card">
          <label>2) Verification</label>
          <div class="muted">
            Verification runs entirely in your browser.
          </div>

          <button id="verifyBtn" class="btn" disabled onclick="verify()">
            Verify report & document
          </button>

          <div id="result" aria-live="polite">
            Awaiting verification‚Ä¶
          </div>

          <details>
            <summary style="cursor:pointer;font-weight:700">
              Advanced / raw data
            </summary>

            <div style="margin-top:12px">
              <div class="small">Report JSON preview</div>
              <pre id="rawJson" class="meta truncate">(no report)</pre>

              <button id="rawToggle" class="show-more" onclick="toggleRaw()">
                Show more
              </button>

              <div class="small" style="margin-top:12px">
                Computed hashes & debug
              </div>
              <pre id="debug" class="meta">(no debug info)</pre>
            </div>
          </details>
        </div>
      </div>
    </div>

    <footer>
      <strong>Privacy:</strong>
      Files never leave your device. All verification runs locally.
    </footer>
  </div>
</body>

<script>
function $(id){return document.getElementById(id);}

// =====================
// Globals
// =====================
let selectedFiles = [];
let processing = false;

let telemetryObj = null;
let previewCount = 5;
const PREVIEW_STEP = 5;

// =====================
// File readers
// =====================
async function readFileAsArrayBuffer(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=e=>res(e.target.result);
    r.onerror=e=>rej(e);
    r.readAsArrayBuffer(file);
  });
}

async function readFileAsText(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=e=>res(e.target.result);
    r.onerror=e=>rej(e);
    r.readAsText(file);
  });
}

// =====================
// SHA-256
// =====================
async function sha256Hex(input){
  let buffer;
  if(typeof input==="string") buffer=new TextEncoder().encode(input);
  else if(input instanceof ArrayBuffer) buffer=input;
  else if(ArrayBuffer.isView(input)) buffer=input.buffer;
  else throw new Error("Unsupported hash input");

  const digest=await crypto.subtle.digest("SHA-256", buffer);
  return Array.from(new Uint8Array(digest))
    .map(b=>b.toString(16).padStart(2,"0"))
    .join("");
}

// =====================
// Drag & drop
// =====================
const dropArea=$("drop-area");
const fileInput=$("file-input");
const verifyBtn=$("verifyBtn");

fileInput.addEventListener("change", e=>handleFiles(e.target.files));
dropArea.addEventListener("click", ()=>fileInput.click());
dropArea.addEventListener("dragover", e=>{
  e.preventDefault();
  dropArea.classList.add("highlight");
});
dropArea.addEventListener("dragleave", ()=>dropArea.classList.remove("highlight"));
dropArea.addEventListener("drop", e=>{
  e.preventDefault();
  dropArea.classList.remove("highlight");
  handleFiles(e.dataTransfer.files);
});

function handleFiles(fileList){
  const map = new Map(selectedFiles.map(f=>[f.name,f]));
  Array.from(fileList).forEach(f=>map.set(f.name,f));
  selectedFiles = Array.from(map.values());
  refreshStatus();
}

// =====================
// Status + gating
// =====================
function refreshStatus(){
  const docx = selectedFiles.find(f=>f.name.toLowerCase().endsWith(".docx"));
  const json = selectedFiles.find(f=>f.name.toLowerCase().endsWith(".json"));

  if(docx){
    $("docx-name").textContent=docx.name;
    $("docx-badge").textContent="Selected";
    $("docx-badge").className="file-badge badge-ok";
  } else {
    $("docx-name").textContent="‚Äî no file selected ‚Äî";
    $("docx-badge").textContent="Missing";
    $("docx-badge").className="file-badge badge-miss";
  }

  if(json){
    $("json-name").textContent=json.name;
    $("json-badge").textContent="Selected";
    $("json-badge").className="file-badge badge-ok";
  } else {
    $("json-name").textContent="‚Äî no file selected ‚Äî";
    $("json-badge").textContent="Missing";
    $("json-badge").className="file-badge badge-miss";
  }

  // üîí Disable verify until both present
  verifyBtn.disabled = !(docx && json);
}

// =====================
// Preview rendering
// =====================
function renderPreview(){
  const rawJsonEl = $("rawJson");
  const toggleBtn = $("rawToggle");

  if(!telemetryObj){
    rawJsonEl.textContent="(no report)";
    toggleBtn.style.display="none";
    return;
  }

  const sessions = telemetryObj.sessions || [];

  const preview = {
    summary: telemetryObj.summary,
    sessions: sessions.slice(0, previewCount)
  };

  rawJsonEl.textContent =
    JSON.stringify(preview, null, 2) +
    (sessions.length > previewCount
      ? `\n\n[Showing ${previewCount} of ${sessions.length} sessions]`
      : "");

  toggleBtn.style.display =
    previewCount >= sessions.length ? "none" : "inline-block";
}

function toggleRaw(){
  if(!telemetryObj) return;
  const sessions = telemetryObj.sessions || [];
  previewCount = Math.min(previewCount + PREVIEW_STEP, sessions.length);
  renderPreview();
}

// =====================
// Flags
// =====================
function collectFlags(pkg){
  const flags={largePaste:0,speedSpike:0,sustainedSpeed:0};
  const arr=pkg.telemetrySession?.sessions ?? pkg.session?.sessions ?? pkg.sessions ?? [];
  if(!Array.isArray(arr)) return flags;

  for(const s of arr){
    if(!s.flags) continue;
    if(s.flags.largePaste) flags.largePaste++;
    if(s.flags.speedSpike) flags.speedSpike++;
    if(s.flags.sustainedSpeed) flags.sustainedSpeed++;
  }
  return flags;
}

// =====================
// Verify
// =====================
async function verify(){
  if(processing) return;
  processing=true;

  try{
    const resultEl=$("result");
    const debugEl=$("debug");

    resultEl.className="";
    resultEl.textContent="Processing‚Ä¶";
    debugEl.textContent="";

    const docxFile=selectedFiles.find(f=>f.name.toLowerCase().endsWith(".docx"));
    const jsonFile=selectedFiles.find(f=>f.name.toLowerCase().endsWith(".json"));

    if(!docxFile || !jsonFile){
      resultEl.className="result-fail";
      resultEl.textContent="‚ùå Please select both a .docx and .json file.";
      return;
    }

    const docBuffer=await readFileAsArrayBuffer(docxFile);
    const computedDocHash=await sha256Hex(docBuffer);

    const jsonText=await readFileAsText(jsonFile);
    const pkg=JSON.parse(jsonText);

    telemetryObj = pkg.telemetrySession ?? pkg.session ?? pkg;
    previewCount = 5;
    renderPreview();

    const recomputedReportHash =
      await sha256Hex(JSON.stringify(telemetryObj));

    const embeddedReportHash =
      pkg.reportIntegrityHash ?? pkg.hash ?? null;

    if(embeddedReportHash && embeddedReportHash !== recomputedReportHash){
      resultEl.className="result-fail";
      resultEl.textContent="‚ùå Report integrity failed.";
      debugEl.textContent=
        `Recomputed: ${recomputedReportHash}\nEmbedded: ${embeddedReportHash}`;
      return;
    }

    const embeddedDocHash =
      pkg.documentIntegrityHash ??
      pkg.summary?.documentIntegrityHash ??
      null;

    if(embeddedDocHash && embeddedDocHash !== computedDocHash){
      resultEl.className="result-fail";
      resultEl.textContent="‚ùå Document mismatch.";
      debugEl.textContent=
        `Computed: ${computedDocHash}\nExpected: ${embeddedDocHash}`;
      return;
    }

    // =====================
    // SUCCESS SUMMARY
    // =====================
    const flags = collectFlags(pkg);
    const totalSessions = telemetryObj.sessions?.length ?? 0;
    const activeTime = telemetryObj.summary?.totalActiveTime ?? "unknown time";

    const hasFlags =
      flags.largePaste || flags.speedSpike || flags.sustainedSpeed;

    const humanSummary =
      `This document was written over ${totalSessions} session${totalSessions!==1?"s":""} ` +
      `(${activeTime}) with ` +
      (hasFlags ? "some suspicious activity detected." : "no suspicious activity detected.");

    const integrityChecklist =
`Integrity checks performed:
‚úî Report hash verified
‚úî Document hash verified
‚úî Telemetry structure valid`;

    const flagSummary =
      hasFlags
        ? `‚Ä¢ Large Paste: ${flags.largePaste}\n‚Ä¢ Speed Spike: ${flags.speedSpike}\n‚Ä¢ Sustained Speed: ${flags.sustainedSpeed}`
        : "None";

    resultEl.className="result-pass";
    resultEl.textContent =
      `‚úÖ VERIFICATION PASSED\n\n` +
      `${humanSummary}\n\n` +
      `${integrityChecklist}\n\n` +
      `Suspicious activity flags:\n${flagSummary}`;

    debugEl.textContent =
      `ComputedReportHash: ${recomputedReportHash}\n` +
      `ComputedDocHash: ${computedDocHash}\n` +
      `ExportedAt: ${pkg.exportedAt ?? pkg.timestamp ?? "N/A"}`;

  } catch(err){
    $("result").className="result-fail";
    $("result").textContent=`‚ùå Error: ${err.message}`;
    $("debug").textContent=err.stack || String(err);
  } finally {
    processing=false;
  }
}

refreshStatus();
</script>
</body>
</html>
